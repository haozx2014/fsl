'mn<HTML><HEAD><link REL="stylesheet" TYPE="text/css" href="../fsl.css">
<TITLE>FIRST</TITLE></HEAD><BODY>
<TABLE BORDER=0 WIDTH="100%"><TR>
<TD ALIGN=LEFT><IMG SRC="egseg.png">
<TD ALIGN=CENTER><H1>FIRST &nbsp; v1.1</H1>
FMRIB's Integrated Registration and Segmentation Tool<br><br>
subcortical brain segmentation using Bayesian shape &amp; appearance models
<TD ALIGN=RIGHT><a href="../index.html"><IMG BORDER=0
SRC="../images/fsl-logo.jpg"></a>
</TR></TABLE>

<a name="intro"></a><p><hr>
<H2>Introduction</H2>

<p>
FIRST is a model-based segmentation/registration tool. The
shape/appearance models used in FIRST are constructed from manually
segmented images provided by the Center for Morphometric Analysis
(CMA), MGH, Boston. The manual labels are parameterized as surface
meshes and modelled as a point distribution model.  Deformable
surfaces are used to automatically parameterize the volumetric labels
in terms of meshes; the deformable surfaces are constrained to
preserve vertex correspondence across the training data.  Furthermore,
normalized intensities along the surface normals are sampled and
modelled. The shape and appearance model is based on multivariate
Gaussian assumptions. Shape is then expressed as a mean with modes of
variation (principal components). Based on our learned models, FIRST
searches through linear combinations of shape modes of variation for
the most probable shape instance given the observed intensities in
your T1 image.

<p>For more information on FIRST, see the
D.Phil. <A
HREF="http://users.fmrib.ox.ac.uk/~brian/brianp_thesis.pdf">thesis</a> or the FMRIB technical <A
HREF="http://www.fmrib.ox.ac.uk/analysis/techrep/tr07bp1/tr07bp1.pdf">report</a>. The thesis provides a more 
thorough and complete description.

<hr><b>Referencing </b>
<br>
<br>
Currently, the thesis is the best reference for FIRST. We've also included the HBM 2007 and 2008 abstract references:
<br>
<br>
1. Brian Patenaude. Bayesian Statistical Models of Shape and Appearance for Subcortical Brain Segmentation. D.Phil. Thesis. University of Oxford. 2007.
<br>
<br>
2. Brian Patenaude, Stephen Smith, David Kennedy, and Mark Jenkinson. Improved Surface Models for FIRST. In Human 
Brian Mapping Conference, 2008.
<br>
<br>
3. Brian Patenaude, Stephen Smith, David Kennedy, and Mark Jenkinson. FIRST - FMRIB's 
integrated registration and segmentation tool. In Human Brain Mapping Conference, 
2007. 
<br>
<br>
<font size=-1><em>
</em></font>

<hr><b>FIRST Training Data Contributors</b>

<p>We are very grateful for the training data for FIRST, particularly
to David Kennedy at the CMA, and also to: Christian Haselgrove, Centre
for Morphometric Analysis, Harvard; Bruce Fischl, Martinos Center for
Biomedical Imaging, MGH; Janis Breeze and Jean Frazier, Child and
Adolescent Neuropsychiatric Research Program, Cambridge Health
Alliance; Larry Seidman and Jill Goldstein, Department of Psychiatry
of Harvard Medical School; Barry Kosofsky, Weill Cornell Medical Center.

<a name="overview"></a><p><hr><H2>Running FIRST</H2>

<p>FIRST segmentation requires firstly that you run <b>first_flirt</b>
  to find the affine transformation to standard space, and secondly
  that you run <b>run_first</b> to segment a single structure
  (re-running it for each further structure that you
  require). Alternatively, you can use <b>run_first_all</b>, which
  does all of the above for you, including running run_first on every
  subcortical structure in the models, and producing a summary
  segmentation image for all structures.
  
  **Please note, if the first stage fails then the models fitting will not work.
  run_first_all continues to run regardless of gross errors in registration.

<UL>

  <LI><b>first_flirt</b> - This script runs two-stage affine
registration to MNI152 space at 1mm resolution (we will assume for
these instructions that the image is named im1.nii.gz). The first
stage is a standard 12 degree of freedom registration to the template.
The second stage applies a 12 degrees of freedom registration using an
MNI152 sub-cortical mask to exclude voxels outside the sub-cortical
regions. 
<br>
<br>

The <b>first_flirt</b> script now registers to the non-linear MNI152 template. The new models that 
are located in <b>${FSLDIR}/data/first/models_336_bin/</b> were all trained using that template for normalization.
This should have minimal effect on the performance of the previous models (<b>${FSLDIR}/data/first/models_317_bin/</b>). The newer models 
also include 19 additional subjects in the training data.
<br>
<br>
Included with FIRST, are models for the left and right cerebellum. Instead of using a subcortical 
mask in the second stage of the registration procedure, a mask of the brain was used. When fitting the cerebellum models, you will need 
to input a different transformation matrix than that used for the other structures. <b>first_flirt</b> will not perform 
the necessary registration by default, the <b>-cort</b> flag must be specified.The cerebellum uses the putamen intensities to normalize its intensity samples (use the -intref option).

<p><b>first_flirt</b> should be used on whole-head (non-betted)
images. Although this option is generally discouraged the flag <b>-b</b>
will allow first_flirt to be used on brain extracted data.

<p>Example usage: 

<p><b>first_flirt</b> im1 im1_to_std_sub

<p>This command will generate the registered (<b>im1_to_std_sub</b>)
as well as the transformation matrix
(<b>im1_to_std_sub.mat</b>). 

<p>Additional options:

<p>The [ -d ] option prevents the deletion of the images and
transformation matrices produced in the intermediary registration
steps. This is used for debugging purposes.

<p>The [ -b ] option uses the brain extracted MNI template rather than the whole head template.

<p>The [ -inweight ] specifies a mask to weight the input image in the
first stage of the registration.

<p>The [ -cort ] option will indicate to first_flirt to perform the alternate "second stage" in addition 
to the standard procedure ("_cort" will be appended to the output name). Rather than 
using a subcortical mask, a brain mask is used. This option should be used if intending to run the cerebellum
models.

<p>You should verify that the registrations were successful prior to
further processing (e.g. using ${FSLDIR}/bin/slicesdir -p
${FSLDIR}/data/standard/MNI152_T1_1mm.nii.gz im*_to_std_sub.nii.gz).
When assessing the registration, pay attention to the sub-cortical
structures. Note that the cortex may not always align well,
particularly where there are large ventricles.

<LI><b>run_first</b> - This script will run FIRST to extract a single
structure. The main arguments that are required are: (-i) the input
image, (-t) transformation matrix, (-o) name of output image, (-n) the
number of modes of variation and (-m) the model.

<p>Example usage:


<p><b> run_first</b> -i im1 -t im1_to_std_sub.mat -n 40 -o output -m ${FSLDIR}/data/first/models_336_bin/L_Hipp_bin.bmv
<br>or
<br><b> run_first</b> -i im1 -t im1_to_std_sub.mat -n 40 -o output -m ${FSLDIR}/data/first/models_336_bin/L_Hipp_bin.bmv -loadvars seg_first.bvars -shcond st1_given_st2.bmap -intref modelRef.bmv

<p><b>Main options:</b>

<p><b>-i</b> : the T1-weighted image (<b>im1</b>) to be segmented.

<p><b>-t</b> : the matrix (<b>im1_to_std_sub.mat</b>) that describes the
transformation of <b>im1</b> into standard space (found by first_flirt).

<p><b>-n</b> : the number of modes of variation to be used in the
fitting. The more modes of variation used the finer details FIRST may
capture, however you may decrease the robustness/reliability of the
results.  The more modes that are included the longer FIRST will take
to run. The current suggested number of modes is for each structure is
given in <a href="./cma_subcortical_label.html">sub-cortical
labels</a>. The suggested number of modes is based on leave-one-out
cross-validation run on the training set. The maximum number of modes
available is either 317 or 336, depending on the model.

<p><b>-o</b> : the (<b>output_name</b>) from FIRST. Three files are
output <b>output_name.vtk</b>, <b>output_name.nii.gz</b>
and <b>output_name.bvars</b>.

<p><b>-m</b> : precedes the model file (e.g. <b>L_Hipp_bin.bmv</b>) ;
they are located in <b>${FSLDIR}/data/first/models_336_bin/</b>.  You
will need to use the full path to the model.

<p><b>Optional options:</b>

<p><b>-loadBvars </b> : Initializes FIRST with a previous estimate of
the structure. If used with "-shcond" it initializes the structure to
be conditioned on.

<p><b>-shcond</b> : This option will run FIRST on a structure given a
previously segmented structure. "-shcond" precedes the mapping file
that maps the mode parameters into the conditional mode
parameters. The [ -loadBvars ] must be used to indicate the
segmentation result of the previous structure. The mapping matrices
are found in <b>${FSLDIR}/data/first/models_317_bin/condMaps/</b> (only for use with the 317 models). The
direction of the conditional is important, for
example, <b>L_CaudCondThal.bmap</b> is used for the left caudate
conditioned on the left thalamus, i.e. the thalamus is segmented first
then the caudate.

<p><b>-intref </b> : This option indicates to FIRST to use a reference
structure for the local intensity normalization.  "intref" precedes
the model files that will be used for reference. The model file used
("-m" option) must correspond to the intensity model corresponding to
the particular reference structure. We currently only provide model
files for the Caudate, Hippocampus, Lateral Ventricles and Amygdala;
they are located
in <b>${FSLDIR}/data/first/models_336_bin/intref/</b>, except the Lateral Ventricles which are located in  <b>${FSLDIR}/data/first/models_317_bin/intref/</b>. They all use
the thalamus as reference. The cerebellum is now included in <b>${FSLDIR}/data/first/models_336_bin/05mm/</b>, it used the putamen as a reference.

<p><b>-multipleImages</b>: This options allows first to run on multiple image by inputting a list of images, 
transformation matrices and output basenames. For a single structure, FIRST will be run on each image independently.
There should be some computational savings due to the fact that the model does not need to be re-read from 
file for each image; the option is primarily included for convenience. When using this option, you should not include the transformation 
matrix with the <b>-t</b> option. The output name specified by the <b>-o</b> option will be appended onto the output name specified in the input 
list. The input list is a plain, 3 column text file. The first column specifies the images (advisable to include full paths), 
the second column is the transformation matrices output by <b>first_flirt</b>, the third column is the base output name.



<P> Example usage:

<p><b>run_first</b> -i image_xfm_output_list.txt -n 40 -o L_Thal_n40 \<br>
 &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp -m ${FSLDIR}/data/first/models_336_bin/05mm/L_Thal_05mm.bmv
<br>
<br>
where  <b>image_xfm_output_list.txt</b> may look like,
<br>
<br>
subject_1_t1 &nbsp &nbsp subject_1_t1_to_mni.mat  &nbsp &nbsp  subject_1<br>
subject_2_t1   &nbsp &nbsp  subject_2_t1_to_mni.mat   &nbsp &nbsp  subject_2<br>
subject_3_t1   &nbsp &nbsp  subject_3_t1_to_mni.mat  &nbsp &nbsp   subject_3<br>
<br>
By using the above command, FIRST would fit <b>L_Thal_05mm.bmv</b> to <b>subject_1</b>, <b>subject_2</b>, and <b>subject_3</b>. The output would 
be a nifti <b>image</b>, <b>.bvars</b> and <b>.vtk</b> output files, with the base names <b>subject_1_L_Thal_n40</b>, <b>subject_2_L_Thal_n40</b>, and 
<b>subject_3_L_Thal_n40</b> respectively.


<LI><b>run_first_all</b> - This script will run FIRST on all the
models (structures) with the optimal number of modes and then apply
boundary correction (see below). A 4D image file is generated; the
first time point contains the boundary corrected segmentations of all
structures combined. The consecutive time points are each structure's
segmentation. The script is written such that if you have FSL setup to
use local cluster computing it will automatically parallelise the
fitting of each structure. 

<b>*This script uses different models from the previous release.</b>

<P> Example usage:

<p><b> run_first_all</b> im1 3 output_name  

<p> The first input is the original T1-weighted structural image.

<p> The second input (<b>3</b>) is the z-value used to threshold the boundary voxels. In this release, this is
not used for the thalamus, putamen, and pallidum. 

<p> The third input (<b>output_name</b>) is the output basename. <b>
run_first_all</b> will append the number of modes of variation and
threshold used to the file name.  For example, the command above would
produce output_name_m60_3_first.nii.gz.

<p> Please be aware that there is no explicit guarantee that
neighbouring structures will not overlap. In the case where there is
overlap the script will add the labels together. Also, even though voxels may overlap, 
it does not necessarily mean that the surfaces intersect.

</UL>

<a name="output"></a><p><hr><H2>Output</H2>

<UL>

<LI><b>output_name</b> : This is the segmented output image. The image
is produced by filling the estimated surface mesh. The output uses the
CMA standard labels (the colour table is built into
FSLView). Currently, the interior is represented with the standard CMA
label, the boundary uses the standard CMA label plus
100. See <a href="./cma_subcortical_label.html">here</a> for a list of
the labels used and their corresponding structures.

<LI><b>output_name.vtk</b> : This is the mesh representation of the final segmentation.

<LI><b>output_name.bvars</b>: Do not delete this file. It contains the mode parameters and the model used. This file along with the
model can reconstruct the other two outputs. The mode parameters are what FIRST optimizes. In the future this output may be used as a shape prior to segment other shapes. 
It may also be used as input for multivariate analysis tools. 

</UL>

<a name="Models"></a><p><hr><H2>Models</H2>

<UL>

<LI> The shape/appearance models used are stored in <b>
${FSLDIR}/data/first/models_317_bin/ </b> and <b>${FSLDIR}/data/first/models_336_bin/ </b>. 
The models were constructed from 317 and 336 subjects respectively, consisting of children and adults, normals and
subjects with pathologies. The structures for which a 336 model was provided, the 317 model has no longer been included.
<br>
<LI> The models in the <b>intref_thal/</b> subdirectories use the intensities from within
the thalamus to normalize the structures' intensities.
<br>
<LI>The models in the <b>05mm/</b> subdirectory (only for the 336 subject models) do not require 
boundary correction (all boundary voxels are considered part of the structure).

<LI> The posterior horns of the lateral ventricles are not yet fully
modelled, so there may be areas of the ventricle horns not labelled as
ventricle.

</UL>


<a name="Future"></a><p><hr><H2>Boundary Correction with first_utils</H2>

The program <b>first_utils</b> is used for the classification of the
boundary voxels. It takes the segmentation image output by FIRST and
classifies the boundary voxels as belonging to the structure or
not. The output volume will have only a single
label. <b>first_utils</b> only works on a single structure at a time.

<p>Usage:

<p><b>first_utils</b> --singleBoundaryCorr -i output_name -r im1 -p 3
-o output_name_corr</b>

<UL>

<LI><b>-i</b> : This option is the segmentation image outputted from FIRST.

<LI><b>-r</b> : This option is the original T1-weighted image.

<LI><b>-p</b> : This option is the z-threshold used to threshold the boundary voxels.

<LI> <b>-o</b> : This option is the name of the output.

</UL>


<p> For the models contained in <b>${FSLDIR}/data/first/models_336_bin/05mm/</b>, all boundary 
voxels are considered as belonging to the structure. <b>fslmaths</b> can be used to combine the boundary 
and interior voxels (e.g. fslmaths subject_1_L_Thal -bin -mul 10 subject_1_L_Thal_bcorr).


<a name="Future"></a><p><hr><H2>first_utils</H2>

first_utils may also be used to fill meshes, calculate Dice overlap,
and perform vertex wise statistics.

<br>
<br>
<UL>
<LI><b>To fill a mesh </b>:
<br>
<br>
Usage:
<b>first_utils</b> --meshToVol -m mesh.vtk -i im1.nii.gz -l fill_value -o output_name
<br>
<br>
<UL>
<LI><b>--meshToVol</b> : Set to fill mesh mode of operation.
<br>
<br>
<LI><b>-i</b> : Base image to which the mesh corresponds.
<br>
<br>
<LI><b>-m</b> : An ASCII vtk mesh.
<br>
<br>
<LI> <b>-o</b> : Name of output volume.
<br>
<br>
<LI> <b>-l</b> : Label with which to fill the mesh (boundary voxels will be assigned label+100).
<br>
<br>
</UL>
<br>
<br>
<LI><b>To calculate vertex-wise statistics to investigate shape differences:</b>:
<br>
<br>
This mode of operation aims to assess group differences on a per-vertex basis. The output is a series of meshes viewable 
in FSLVIEW. The base mesh is the mean mesh for the first group the vectors are the displacement vectors between group means.
The slider in the mesh controls panel in FSLVIEW will allow you to deform the mesh between means. The surface colouring 
is the F approximation to the multivariate statistic (either Pillai's Trace or Wilks' Lambda).
<br>
<br>
Usage:
<b>first_utils</b> --usebvars --vertexAnalysis -i concatenated_bvars -d design.mat -o output_basename [--useReconNative -f flirt_matrices] [--useReconMNI] [--usePCAfilter -n number_of_modes] [--useRigidAlign] [-useWilks]
<br>
<br>
<UL>
<LI><b>--usebvars</b> : Set mode of operation such that it uses the mode parameters and to apply the GLM.
<br>
<br>
<LI><b>--vertexAnalysis</b> : Set mode of operation such that vertex-wise stats are used instead of producing volumes.
<br>
<br>
<LI><b>-i</b> : bvars file that contains all modes parameters .
<br>
<br>
<LI> <b>-o</b> : Base name of output meshes.
<br>
<br>
<LI> <b>-d</b> : FSL design matrix.
<br>
<br>
<LI> <b>--useReconNative</b> : Reconstructs the meshes in the native space of the image (requires <b>-f</b> option). For vertex-wise stats should 
used <b>--useRigidAlign</b>. 
<br>
<br>
<LI> <b>-f</b> : List of flirt matrices output from <b>first_flirt</b>. The order of the matrix name is important and should 
correspond to the subject order found in the ".bvars" file. 
<br>
<br>
<LI> <b>--useReconMNI</b> : Reconstructs the meshes MNI space (native space of the model). This does not require the flirt matrices.
<br>
<br>
<LI> <b>--useRigidAlign</b> : Uses a 6 degrees of freedom transformation to remove pose from the meshes (see <b> --useScale </b> if you wish to remove size as well).
All meshes are aligned to the mean shape as determined by the shape Model.
<br>
<br>
<LI> <b>--useScale</b> : Used in conjunction with <b>--useRigidAlign</b>, it will include scale when aligning meshes.
<br>
<br>
<LI> <b>--usePCAfilter</b> :  Used in conjunction with <b>-n number_of_modes</b>. When used the number of modes used to reconstruct the mesh will be truncated
at the integer "number_of_modes". 
<br>
<br>
<LI> <b>--useWilks</b> : By default Pillai's trace is used to measure group difference in the vertices (the output is an F approximation). This option will use Pillai's trace instead.
<br>
<br>
</UL>
<LI><b>To calculate volumes from bvars files and apply GLM:</b>:
<br>
<br>
Usage:
<b>first_utils</b> --usebvars -m mesh.vtk -i im1.nii.gz -l fill_value -o output_name -d design.mat -p bcorr_thresh [--useReconNative -f flirt_matrices] [--usexReconMNI] [--usePCAfilter -n number_of_modes] [--useRigidAlign] [--useNorm -g norm.txt]
<br>
<br>
The output will be of the form <b>output_name.vols</b> which contains subject name and volumes. Also a <b>output_nameN.tstat</b>
will be output for each EV where "N" corresponds to the EV number. Each file contains 
the t-statistic for the main effect of that EV.
<br>
<br>
<UL>
<LI><b>--usebvars</b> : Set mode of operation such that it uses the mode parameters to generate volumes (unless --vertexAnalysis is used, see below) and to apply the GLM.
<br>
<br>
<LI><b>-i</b> : bvars file that contains all modes parameters .
<br>
<br>
<LI> <b>-o</b> : Name of output volume.
<br>
<br>
<LI> <b>-l</b> : Label with which to fill the mesh (boundary voxels will be assigned label+100).
<br>
<br>
<LI> <b>-d design.mat </b> : FSL design matrix.
<br>
<br>
<LI> <b>-p</b> : Boundary correction threshold.
<br>
<br>
<LI> <b>--useNorm</b> : Used in conjunction with <b>-g norm.txt</b>. It allows for the scaling of each volume measure (as specified by norm.txt) prior to running the GLM.
The output volumes will be the scaled volumes. The typical used for this option would be to normalize for head size.
<br>
<br>
<LI> The reconstruction and alignment options are the same as for the above.
</UL>
</UL>
<a name="Future"></a><p><hr><H2>concat_bvars</H2>
<UL>
<b>concat_bvars</b> is used to concatenate the ".bvars" files across subjects. All subjects should be created using the same model.
concat_bvars will keep track of the number of subjects that it contains.
<br>
<br>
Usage:
<b>concat_bvars</b> output_name [list of ".bvars" files]
<br>
<br>
Please note that it will automatically write over output_name so do not forget the output name or else it will write
over the first ".bvars" file.
<br>
<br>
</UL>
</UL>
<a name="Future"></a><p><hr><H2>first_roi_slicesdir</H2>
<UL>
<b>first_roi_slicesdir</b> is a script to run slicesdir on a region of interest defined by a set of label images 
(e.g. output of FIRST). A set of temporary roi images are created, slicesdir is then run on those.
<br>
<br>
Usage:
<b>first_roi_slicesdir</b>  input_t1_images input_label_images
<br>
<br>
</UL>


