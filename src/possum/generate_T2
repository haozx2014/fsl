#!/usr/local/bin/bash
Usage() {
    echo ""
    echo "Usage: generate_T2 <fmri data> <zstart> <thc>"
    echo ""
    echo "Inputs are:"
    echo "the FMRI data you estimate T2* from"
    echo "zstart in the volume(same space as the space of the digital phantom)"
    echo "thc : amount of the z direction needed (in mm)"
    echo "Output is the T2* data registered to the POSSUM digital phantom."
    exit
}
[ "$1" = "" ] && Usage

DATA=$1
zstart=$2 #starting z
thc=$3

TE=0.03
NoV=177 #number of volumes, have to find out what is the command to extract number of volumes from the data.. fslhd but ??
NoV1=`expr ${NoV} - 1`

fslinfo ${DATA}

echo "making ones"
fslmaths ${DATA} -add 1 ${DATA}_ones
fslmaths ${DATA}_ones -bin ${DATA}_ones

echo "making TE"
fslmaths ${DATA}_ones -mul ${TE} ${DATA}_TE -odt float

echo "motion removal"
mcflirt -in ${DATA}

#equation is ${DATA}=${DATA}_S0*exp(-${DATA}_TE/${DATA}_t2) and we need ${DATA}_t2 which is:
#  ${DATA}_t2=${DATA}_TE/log(${DATA}_S0/${DATA}) and we choose ${DATA}_S0=max(${DATA})*exp(1/2) because we
#  need t2 to be somewhere between 0.05 and 0.07 (from real data)

echo "making S0"
fslmaths ${DATA}_mcf -Tmax ${DATA}_S0 -odt float
fslmaths ${DATA}_S0 -mul 1.6 ${DATA}_S0 -odt float
fslmaths ${DATA}_ones -mul ${DATA}_S0 ${DATA}_S0 -odt float
rm ${DATA}_ones*

echo "Calculating T2* map"
fslmaths ${DATA}_S0 -div ${DATA}_mcf ${DATA}_S0 -odt float
fslmaths ${DATA}_S0 -log ${DATA}_S0 -odt float
fslmaths ${DATA}_TE -div ${DATA}_S0 ${DATA}_t2 -odt float
rm ${DATA}_mcf*
rm ${DATA}_TE*
rm ${DATA}_S0*

REF=/usr/people/ivana/possum_data/input/phantom/brain_basictissue_ref

echo "Registering T2* map to the POSSUM input digital phantom "

echo "1.first vol from the T2* data to REF vol of the dig phantom -- resolution fit"
fslroi ${DATA} ${DATA}_reg 0 1
flirt -in ${DATA}_reg -ref ${REF} -omat transmat
rm ${DATA}_reg*

echo "2.applying derived transmat on all volumes of the T2* data -- into higher resolution"
i=0
fslroi ${REF} ${DATA}_t2_IC2 0 181 0 217 ${zstart} ${thc}
while [ $i -le ${NoV1} ] ; do
  fslroi ${DATA}_t2 ${DATA}_t2_$i $i 1 
  flirt -in ${DATA}_t2_$i -ref ${REF} -applyxfm -init transmat -out ${DATA}_t2_$i
  fslroi ${DATA}_t2_$i ${DATA}_t2_$i 0 181 0 217 ${zstart} ${thc}
  fslmerge -t ${DATA}_t2_IC2 ${DATA}_t2_IC2 ${DATA}_t2_$i 
  rm ${DATA}_t2_$i*
  i=`expr $i + 1`
  echo $i
done
fslroi ${DATA}_t2_IC2 ${DATA}_t2_IC2 1 ${NoV}
fslinfo ${DATA}_t2_IC2
